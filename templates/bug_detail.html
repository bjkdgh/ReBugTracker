<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 
    数据字段映射说明：
    bug.id = 问题ID (数据库字段: id)
    bug.title = 问题标题 (数据库字段: title)
    bug.description = 问题描述 (数据库字段: description)
    bug.status = 当前状态 (数据库字段: status)
    bug.created_at = 创建时间 (数据库字段: created_at)
    bug.resolved_at = 解决时间 (数据库字段: resolved_at)
    bug.resolution = 解决方案 (数据库字段: resolution)
    bug.screenshot_path = 截图路径 (数据库字段: screenshot_path)
    bug.creator_name = 提交人姓名 (通过creator_id关联users表获取)
    bug.assignee_name = 负责人姓名 (通过assignee_id关联users表获取)
    -->
    <title>问题详情 #{{ bug.id }}</title>
    <style>
        body { font-family: 'Arial', sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        h1 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .bug-detail { margin-top: 20px; }
        .bug-title { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
        .bug-meta { font-size: 14px; color: #7f8c8d; margin-bottom: 20px; }
        .bug-status { display: inline-block; padding: 5px 10px; border-radius: 15px; font-size: 18px; }
        .status-pending { background-color: #f39c12; color: white; }
        .status-assigned { background-color: #3498db; color: white; }
        .status-resolving { background-color: #2ecc71; color: white; }
        .status-resolved { background-color: #9b59b6; color: white; }
        .bug-description { margin: 20px 0; line-height: 1.6; }
        .bug-image { margin-top: 20px; max-width: 100%; }
        .bug-resolution { margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 5px; }
        .resolution-title { font-weight: bold; margin-bottom: 10px; }
        .back-link { display: inline-block; margin-top: 20px; }
        .btn { padding: 6px 12px; background-color: #3498db; color: white; border: none; border-radius: 4px; text-decoration: none; }
    </style>
</head>
<body>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
            <a href="/" class="btn" style="background-color: #3498db;">← 返回问题列表</a>
        </div>
        <div style="display: flex; align-items: center; gap: 20px;">
            <div style="text-align: right;">
                <div style="font-weight: bold;">{{ session.username }}</div>
                <div style="font-size: 0.8em; color: #666;">{{ session.role }}{% if session.team %} | {{ session.team }}{% endif %}</div>
            </div>
            <a href="/logout" class="btn" style="background-color: #e74c3c; color: white; text-decoration: none;">退出登录</a>
        </div>
    </div>
    <div class="bug-detail">
        <div class="bug-title">
            #{{ bug.id }} - {{ bug.title }}
            <span class="bug-status status-{{ bug.status.lower().replace(' ', '-') }}">{{ bug.status }}</span>
        </div>
        <div class="bug-meta">
            提交人: {{ bug.creator_name }} | 创建时间: {{ bug.created_at }}
            {% if bug.assignee_name %} | 负责人: {{ bug.assignee_name }}{% endif %}
            {% if bug.resolved_at %} | 解决时间: {{ bug.resolved_at }}{% endif %}
        </div>
        <div class="bug-description">
            {{ bug.description|replace('\n', '<br>')|safe }}
        </div>
        {% if bug.image_path or bug.attachments %}
        <div class="bug-attachments">
            <h3>附件</h3>
            {% if bug.image_path %}
            <div class="attachment-item">
                <img src="{{ bug.image_path }}" alt="问题截图" style="max-width: 100%; border: 1px solid #ddd;">
            </div>
            {% endif %}
            {% if bug.attachments %}
                {% for attachment in bug.attachments %}
                <div class="attachment-item">
                    {% if attachment.type == 'image' %}
                        <img src="{{ attachment.path }}" alt="附件图片" style="max-width: 100%; border: 1px solid #ddd;">
                    {% else %}
                        <a href="{{ attachment.path }}" download>下载附件: {{ attachment.name }}</a>
                    {% endif %}
                </div>
                {% endfor %}
            {% endif %}
        </div>
        {% endif %}
        {% if bug.resolution %}
        <div class="bug-resolution">
            <div class="resolution-title">解决方案</div>
            <div>{{ bug.resolution|replace('\n', '<br>')|safe }}</div>
        </div>
        {% endif %}
        
        
        {% if session.role == '负责人' or session.role == '管理员' %}
        <div style="margin-top: 20px;">
            <a href="/bug/assign/{{ bug.id }}" class="btn" style="background-color: #2ecc71;">指派</a>
        </div>
        {% endif %}
        
        {% if message %}
        <div class="alert alert-success" role="alert" style="margin-top: 20px; padding: 15px; border-radius: 4px; background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb;">
            {{ message }}
        </div>
        {% endif %}
    </div>
    
    <script>
    // 删除问题函数
    function deleteBug(bugId) {
        if(confirm('确定要删除这个问题吗？')) {
            fetch('/bug/delete/' + bugId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})
            }).then(function(response) {
                if (!response.ok) {
                    throw new Error('网络响应不正常');
                }
                return response.json();
            }).then(function(data) {
                if(data.success) {
                    alert('删除成功！');
                    window.location.href = '/?message=问题已成功删除';
                } else {
                    alert('删除失败: ' + data.message);
                }
            }).catch(function(error) {
                alert('删除请求失败: ' + error.message);
            });
        }
    }
    </script>
</body>
</html>
